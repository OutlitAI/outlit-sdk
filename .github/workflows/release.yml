name: Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  # Always publish canary to npm on every main push
  canary:
    name: Publish Canary
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Create canary versions
        run: |
          # Generate snapshot version like 0.1.0-canary-20231210-abc1234
          TIMESTAMP=$(date +%Y%m%d%H%M)
          SHORT_SHA=$(git rev-parse --short HEAD)
          pnpm changeset version --snapshot canary-${TIMESTAMP}-${SHORT_SHA}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish canary to npm
        run: pnpm changeset publish --tag canary --no-git-tag
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy canary IIFE to CDN
        run: |
          gcloud storage cp packages/browser/dist/outlit.global.js \
            gs://cdn.outlit.ai/canary/outlit.js \
            --cache-control="public, max-age=300" \
            --content-type="application/javascript"

      - name: Summary
        run: |
          echo "## Canary Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**npm:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm install @outlit/browser@canary" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CDN:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`html" >> $GITHUB_STEP_SUMMARY
          echo '<script src="https://storage.googleapis.com/cdn.outlit.ai/canary/outlit.js"></script>' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Handle stable releases via Changesets
  release:
    name: Release
    needs: canary
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      published: ${{ steps.changesets.outputs.published }}
      publishedPackages: ${{ steps.changesets.outputs.publishedPackages }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create Release PR or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          publish: pnpm release
          title: "chore: version packages"
          commit: "chore: version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  deploy-cdn:
    name: Deploy to CDN
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Get browser package version
        id: version
        run: |
          VERSION=$(node -p "require('./packages/browser/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v3

      - name: Deploy versioned IIFE
        run: |
          echo "Deploying to v${{ steps.version.outputs.version }}/outlit.js"
          gcloud storage cp packages/browser/dist/outlit.global.js \
            "gs://cdn.outlit.ai/v${{ steps.version.outputs.version }}/outlit.js" \
            --cache-control="public, max-age=31536000, immutable" \
            --content-type="application/javascript"

      - name: Deploy to stable
        run: |
          echo "Deploying to stable/outlit.js"
          gcloud storage cp packages/browser/dist/outlit.global.js \
            gs://cdn.outlit.ai/stable/outlit.js \
            --cache-control="public, max-age=31536000, immutable" \
            --content-type="application/javascript"

      - name: Summary
        run: |
          echo "## CDN Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- Versioned: https://storage.googleapis.com/cdn.outlit.ai/v${{ steps.version.outputs.version }}/outlit.js" >> $GITHUB_STEP_SUMMARY
          echo "- Stable: https://storage.googleapis.com/cdn.outlit.ai/stable/outlit.js" >> $GITHUB_STEP_SUMMARY
