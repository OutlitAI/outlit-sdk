<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cal.com Embed Test Page</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; }
    h1 { margin-bottom: 10px; }
    .calendar-container { 
      margin: 20px 0; 
      width: 100%;
      height: 700px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }
    #status { margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 4px; }
    .debug { margin-top: 20px; padding: 10px; background: #fff3cd; border-radius: 4px; font-size: 12px; max-height: 150px; overflow-y: auto; }
    .debug pre { margin: 5px 0; overflow-x: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Cal.com Embed Test - Real Booking</h1>
  <p>This page embeds the real Cal.com booking widget for <strong>15 Min Meeting</strong>.</p>

  <!-- Container for Cal.com inline embed -->
  <div id="cal-embed" class="calendar-container"></div>

  <div id="status">
    <strong>Status:</strong> <span id="status-text">Loading Cal.com embed...</span>
  </div>

  <div class="debug">
    <strong>Debug Log:</strong>
    <pre id="debug-info">Initializing...</pre>
  </div>

  <!-- 
    Load the REAL Cal.com embed script and embed the actual booking page.
    This uses Josh's real Cal.com event: https://cal.com/josh-earle/outlit-introduction-chat
  -->
  <script type="text/javascript">
    // Store registered callbacks so we can verify the SDK hooks in
    window.__calCallbacks = { bookingSuccessfulV2: [] };
    window.__calendarEventReceived = false;
    
    // Cal.com embed loader (official Cal.com embed code)
    (function (C, A, L) {
      let p = function (a, ar) { a.q.push(ar); };
      let d = C.document;
      C.Cal = C.Cal || function () {
        let cal = C.Cal;
        let ar = arguments;
        if (!cal.loaded) {
          cal.ns = {};
          cal.q = cal.q || [];
          d.head.appendChild(d.createElement("script")).src = A;
          cal.loaded = true;
        }
        
        // Intercept "on" calls to capture callbacks for testing verification
        if (ar[0] === "on" && ar[1] && ar[1].action === "bookingSuccessfulV2") {
          console.log('[Cal Embed] Captured bookingSuccessfulV2 callback registration');
          window.__calCallbacks.bookingSuccessfulV2.push(ar[1].callback);
        }
        
        if (ar[0] === L) {
          const api = function () { p(api, arguments); };
          const namespace = ar[1];
          api.q = api.q || [];
          if (typeof namespace === "string") { 
            cal.ns[namespace] = cal.ns[namespace] || api; 
            p(cal.ns[namespace], ar); 
            p(cal, ["initNamespace", namespace]); 
          } else {
            p(cal, ar);
          }
          return;
        }
        p(cal, ar);
      };
    })(window, "https://app.cal.com/embed/embed.js", "init");

    // Initialize Cal.com embed with the REAL booking link
    Cal("init", { origin: "https://cal.com" });
    
    // Embed Leo's 15 min meeting (simpler form - just name and email)
    Cal("inline", {
      elementOrSelector: "#cal-embed",
      calLink: "leo-paz/15min",
      layout: "month_view",
      config: {
        layout: "month_view"
      }
    });

    // Set up UI configuration
    Cal("ui", {
      styles: { branding: { brandColor: "#000000" } },
      hideEventTypeDetails: false,
      layout: "month_view"
    });
    
    // Listen for booking success - this will fire when a REAL booking is made
    Cal("on", {
      action: "bookingSuccessfulV2",
      callback: (e) => {
        console.log('[Cal Embed] BOOKING SUCCESSFUL!', e.detail);
        window.__calendarEventReceived = true;
        window.__lastBookingData = e.detail.data;
        
        const debugEl = document.getElementById('debug-info');
        const statusEl = document.getElementById('status-text');
        if (debugEl) {
          debugEl.textContent = 'BOOKING CONFIRMED: ' + JSON.stringify(e.detail.data, null, 2);
        }
        if (statusEl) {
          statusEl.textContent = 'âœ… Booking successful! Event: ' + (e.detail.data?.title || 'Unknown');
        }
      }
    });
  </script>

  <!-- Load Outlit SDK after Cal.com loader is set up -->
  <script src="/outlit.global.js" data-public-key="pk_test_key_12345"></script>

  <script>
    const debugEl = document.getElementById('debug-info');
    const statusEl = document.getElementById('status-text');
    
    function log(msg) {
      console.log('[Test Page]', msg);
      const time = new Date().toLocaleTimeString();
      debugEl.textContent = `[${time}] ${msg}\n` + debugEl.textContent;
    }

    // Wait for Outlit SDK to be ready
    function waitForOutlit(callback) {
      if (window.outlit && window.outlit._initialized) {
        callback();
      } else {
        setTimeout(() => waitForOutlit(callback), 50);
      }
    }

    waitForOutlit(() => {
      const callbackCount = window.__calCallbacks.bookingSuccessfulV2.length;
      statusEl.textContent = 'SDK ready. Cal.com callbacks: ' + callbackCount + '. Select a time slot to book.';
      log('Outlit SDK initialized');
      log('Registered Cal.com callbacks: ' + callbackCount);
      log('Visitor ID: ' + (window.outlit.getVisitorId() || 'none'));
    });
  </script>
</body>
</html>
